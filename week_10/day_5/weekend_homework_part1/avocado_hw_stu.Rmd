---
title: "Model Building"
author: "Stuart McColl"
date: "09/01/2021"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Part 1

### Load in libraries and data

```{r, warning=FALSE, message=FALSE}

library(tidyverse)
library(leaps)
library(glmulti)
library(relaimpo)
library(modelr)
library(GGally)
library(lm.beta)
library(janitor)
library(lubridate)
library(fastDummies)

avocado_raw <- read_csv("data/avocado.csv") %>% 
  clean_names()

```

# Part 2

### Prepare data for modelling

```{r}

glimpse(avocado_raw)

```


```{r}

summary(avocado_raw)

```


My initial thoughts are to drop the following columns as they all add up 
to the 'total_volume':

* x4046
* x4225
* x4770
* total_bags
* small_bags
* large_bags
* x_large_bags

However, it may be worth keeping them and checking for any correlations,
the number of 'small_bags' sold, for example, may have an affect on 
'average_price'. Therefore, it might be better to drop the 'total_volume' 
and 'total_bags' columns as the other columns add up to these totals.

I would also convert the 'type' column to a 'factor', i.e. T or F 
if organic or not. 

Initial thoughts on the columns:

**1. date: The date of the observation**

Extracting the month and maybe creating a season column could create 
a useful predictor.

**2. average_price: the average price of a single avocado**

This is the outcome or 'y'.

**3. total_volume: Total number of avocados sold**

Could drop as other columns add up to this.

**4. x4046: Total number of avocados with PLU 4046 sold**

Potential predictor.

**5. x4225: Total number of avocados with PLU 4225 sold**

Potential predictor.

**6. x4770: Total number of avocados with PLU 4770 sold**

Potential predictor.

**7. total_bags**

Could drop as other columns add up to this.

**8. small_bags**

Potential predictor.

**9. large_bags**

Potential predictor.

**10. x_large_bags**

Potential predictor.

**11. type: conventional or organic**

Potential predictor. Change to 'factor'.

**12. year: the year**

Potential predictor. 

**13. region: the city or region of the observation**

Potential predictor. May drop due to amount of dummy variables.

#### Cleaning

```{r}

# Convert 'type' column to 'organic', T or F:

avocado_clean <- avocado_raw %>% 
  mutate(organic = ifelse(type == "organic", 1, 0)) 

avocado_clean

```

```{r}

# Extract 'month' from 'date' using 'lubridate':

avocado_clean <- avocado_clean %>%
  mutate(month = as.factor(month(date, label = T, abbr = F)))

avocado_clean

```

```{r}

# Select relevant columns:

avocado_clean <- avocado_clean %>% 
  dplyr::select(-c(x1, date, total_volume, total_bags, type, region))

avocado_clean

```

```{r}

# Change categorical columns to 'factor' class:

avocado_clean <- avocado_clean %>% 
  mutate(year = as.factor(year)) 

avocado_clean


```

```{r}

# Create a new column for 'season':

avocado_clean <- avocado_clean %>% 
  mutate(season = recode(month, 
                         December = "Winter",
                         January = "Winter",
                         February = "Winter",
                         March = "Spring",
                         April = "Spring",
                         May = "Spring",
                         June = "Summer",
                         July = "Summer",
                         August = "Summer",
                         September = "Autumn",
                         October = "Autumn",
                         November = "Autumn"
                         ))

avocado_clean

```

```{r}

# Create dummy variable for Season to allow for correlation calculation:

avocado_clean <- avocado_clean %>% 
  mutate(season_spring = ifelse(season == "Spring", 1, 0)) %>% 
  mutate(season_summer = ifelse(season == "Summer", 1, 0)) %>% 
  mutate(season_autumn = ifelse(season == "Autumn", 1, 0)) %>% 
  mutate(season_winter = ifelse(season == "Winter", 1, 0))


avocado_clean

```



```{r}

# Check for correlations in the variables:

avocado_clean %>% 
  summarise(x4046_cor = cor(average_price, x4046), 
            x4225_cor = cor(average_price, x4225),
            x4770_cor = cor(average_price, x4770),
            small_bags_cor = cor(average_price, small_bags),
            large_bags_cor = cor(average_price, large_bags),
            x_large_bags_cor = cor(average_price, x_large_bags),
            organic_cor = cor(average_price, organic),
            season_spring_cor = cor(average_price, season_spring),
            season_summer_cor = cor(average_price, season_summer),
            season_autumn_cor = cor(average_price, season_autumn),
            season_winter_cor = cor(average_price, season_winter))


```

I decided to use the cor() function instead of using ggpairs(), because I find
it difficult to interpret the results of ggpair(), especially when there are a lot of 
variables.

This method does take longer and requires dummy variable to be created for 
categorical variables, however I feel that it is more thorough and easier to
interpret.

The correlation results allow you to make a selection for the modeling.

RESULTS

As you can see from the correlation test above, the following had the top,
positive correlation:

1. organic_cor = 0.6158449
2. season_autumn_cor = 0.1770793
3. season_summer_cor = 0.07696605


# Part 3

### Model building

Letâ€™s start with organic:

```{r}

model_organic <- lm(average_price ~ organic, data = avocado_clean)

summary(model_organic)

```

This is a good start, as you can see that organic accounts for 37% of the 
variance in average price.

Check the diagnostics:

```{r}

par(mfrow = c(2, 2)) 

plot(model_organic)

```

The results from the diagnostics show that the fitted values are very spread 
out and therefore not a great fit. The 'Q-Q' results start off okay, then 
move away towards the end.

Season Autumn:

```{r}

model_autumn <- lm(average_price ~ season_autumn, data = avocado_clean)

summary(model_autumn)

```

This is not such a great model as the r squared value is very low, only 3%.

Diagnostics:

```{r}

par(mfrow = c(2, 2)) 

plot(model_autumn)

```

The diagnostics show similar results to the previous model, only worse.

Summer Model:

```{r}

model_summer <- lm(average_price ~ season_summer, data = avocado_clean)

summary(model_summer)

```

This is an even weaker model.

Diagnostics:

```{r}

par(mfrow = c(2, 2)) 

plot(model_summer)

```

Similar to the autumn model above.

Winner = Organic for 1st predictor.

Second predictor:

```{r}

model_organic_autumn <- lm(average_price ~ organic + season_autumn, data = avocado_clean)

summary(model_organic_autumn)

```

As you can see from the results, adding in the Autumn variable has increased
the r squared value from 37% to 41%.

Diagnostics:

```{r}

par(mfrow = c(2, 2)) 

plot(model_organic_autumn)

```

The diagnostics are still not ideal.

Organic Summer Model:

```{r}

model_organic_summer <- lm(average_price ~ organic + season_summer, data = avocado_clean)

summary(model_organic_summer)

```

This has had very little effect on the r squared value.

Include all three variable in model:

```{r}

model_organic_autumn_summer <- lm(average_price ~ organic + season_autumn + season_summer, data = avocado_clean)

summary(model_organic_autumn_summer)

```

This final model, including all three variables is okay, the r squared value
is around 43%.

Perhaps if I had included 'region' into the model making, I would of been able
to increase the r squared value.


