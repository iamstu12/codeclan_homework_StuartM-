---
title: "Dates, times and time series homework"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    css: ../../../styles.css
  pdf_document: default
---

Load in the following libraries and data:

```{r, warning = FALSE, message = FALSE}

library(dplyr)
library(lubridate)
library(tidyverse)
library(tsibble)
library(tsibbledata)
library(feasts)
library(nycflights13)
library(slider)

date1 <- ymd_hms("2017-04-22 22:01:18")
date2 <- ymd_hms("2001-11-07 10:09:56")

```


# Dates and Times

<br>
**Question 1**  

Extract the different components (year, month, mday, yday, wday) from the variable `date1`. Add the labels to the month and do not abbreviate the month labels. 

```{r}

year(date1)
month(date1, label = T, abbr = F)
mday(date1)
yday(date1)
wday(date1)

```


<br>


<br>
**Question 2**  

Add 14 days to your `date1` variable and store it in a variable called `next_fortnight`. 
Take away 10 years from your `date2` variable, and store it in `previous_decade`. 


```{r}

next_fortnight <- date1 + days(14)

next_fortnight

previous_decade <- date2 - years(10)

previous_decade

```


<br>


<br>
**Question 3**  

Create a variable called `this_year` which contains today's date. Then create an interval object which uses `this_year` and the `previous_decade` variable you made above. Store it in `interval_years`. 
 

```{r}

this_year <- now(tz = "Europe/London")

this_year

interval_years <- lubridate::interval(previous_decade, this_year, tz = "Europe/London")

interval_years

```



<br>


<br>
**Question 4**    

Change the time zone of both your date variables to "America/New_York", and call them `nyc_date1` and `nyc_date2`. 

```{r}

nyc_date1 <- ymd_hms("2017-04-22 22:01:18", tz = "America/New_York")
nyc_date2 <- ymd_hms("2001-11-07 10:09:56", tz = "America/New_York")

nyc_date1
nyc_date2

```


<br>


<br>
**Question 5**  

Use the `flights` data from the `nycflights13` dataset. Make a date-time column called `departure_date` from the `year, month, day, hour, and minute` variables in the `flights` tibble.

```{r}

flights

flights %>% 
  mutate(departure_date = make_datetime(year, month, day, hour, minute))

```


<br>




# Time series familiarity 


<br>
**Question 6**  

Start with the `weather` data from the `nycflights13` package. Select all the variables related to temperature, humidity, and precipitation, and pick out the key and index variables. Have a look at your data, and write a small description of the time series you observe. 

Observation: Data is collected in hourly format, with observations occurring every day. 

```{r}

head(weather)

weather %>% 
  select(temp, humid, precip, time_hour, year, month, day, hour)

```


<br>


<br>
**Question 7**  

Change the weather data into a tsibble. Hint, look up in the notes where we suggest using `as_tsibble` function. You'll need to define an `index` and `key`.


In order to create a time series tibble, remember you need to provide an *index* and a *key*. In our case, `time_hour` is the only column involving a date/date-time, and so this would be our index. A `tsibble` also requires a key, which defines individual observations that are tracked over time. In this example, the `origin` variable is the identifier, and therefore is our key. It is important to note that the duo of the index and key uniquely identifies each observation in a valid `tsibble`.   


```{r}

weather_tsibble <- as_tsibble(weather, index = "time_hour", key = "origin")

weather_tsibble

class(weather_tsibble)

```


<br>
**Question 8**  

Add a year and month column to your new tsibble weather data, and create a basic line plot which shows the temperature data from each airport over time. Have a think back to what you learned in visualisation week, and think about whether plotting the whole time series in one go is adequate here? Write down your suggestions for what could be done to make a better and more informative plot. 

```{r}

weather_tsibble <- weather_tsibble %>% 
  mutate(year = year(time_hour)) %>% 
  mutate(month = month(time_hour))

weather_tsibble

```

```{r}

weather_temp_month <- weather_tsibble %>% 
  index_by(month = month(time_hour, label = TRUE)) %>% 
  summarise(mean_temp = mean(temp))

weather_temp_month %>% 
  ggplot(aes(x = month, y = mean_temp)) +
  geom_point() +
  geom_line(group = 1)


```



<br>


<br>
**Question 9**  

Choose an appropriate rolling window and calculate a moving average for your weather temperature data for each airport origin. Create a useful plot which overlays the original time series data and the rolling average data. Make sure the graph is easy for others to understand (*Hint: you might want to facet_wrap*). Finally, write a summary of why you chose the time window you did, and describe any trends you see. 

```{r}

weather_rolling <- weather_tsibble %>% 
  mutate(
    temp_moving_avg = slide_dbl(
      .x = temp,
      .f = ~ mean(., na.rm = TRUE),
      .before = 600,
      .after = 600
    )
  )

weather_rolling

```

```{r}

ggplot(weather_rolling) +
  geom_line(aes(x = time_hour, y = temp), colour = "grey60") +
  geom_line(aes(x = time_hour, y = temp_moving_avg), colour = "dark green") +
  facet_wrap(~ origin)


```



<br>


<br>
**Question 10**  

Downsample your data so that you plot daily temperature data for each airport, instead of hourly data. 

```{r}

weather_temp_day <- weather_tsibble %>% 
  index_by(day = day(time_hour)) %>% 
  summarise(mean_temp = mean(temp))

weather_temp_day %>% 
  ggplot(aes(x = day, y = mean_temp)) +
  geom_point() +
  geom_line(group = 1)

```



<br>

